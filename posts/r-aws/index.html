<!DOCTYPE html>
<html lang="en">
<head>
		<meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <!-- fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;700&display=swap" rel="stylesheet"> 
        <!-- styles -->
        <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-coy.css" rel="stylesheet">
        <link rel="stylesheet" href="/css/index.css">
        <title>R, AWS, and other letters - amfz</title>
</head>
<body> 
    <div id="site">
        <header>
            <nav>
                <ul role="list">
                    <li class="nav-item"><a  href="/">home</a></li>
                    <li class="nav-item"><a  href="/projects/">projects</a></li>
                    <li class="nav-item"><a aria-current="page" href="/posts/">blog</a></li>
                    <li class="nav-item"><a  href="/about/">about</a></li>
                </ul>
            </nav>
        </header>
        <main>
            
        <article class="post">
            
                
                    <h1>R, AWS, and other letters</h1>
                
            

            <p>Got a crash course in working with Amazon Web Services today.</p>
<h3>What I was trying to do</h3>
<p>Scale up a text processing project by moving to AWS. The scale-up will need an estimated 100 GB of storage, and an unknown amount of computing power.</p>
<h3>What I Did</h3>
<h4>1. Create a new EC2 instance</h4>
<p>EC2 stands for Elastic Compute Cloud and provides pay-as-you-go virtual computing environments. There are <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts.html">a ton of features</a>, but the main ones to pay attention to for now are:</p>
<ul>
<li>the <strong>instance type</strong>, which defines the CPU, memory, storage, and networking capacities of the virtual machine;</li>
<li>the <strong>Amazon Machine Image (AMI)</strong>, which is a template for the operating system and additional software the instance should start out with;</li>
<li>and storage options for the virtual machine. <strong>Instance store volumes</strong> provide temporary storage that gets deleted when the instance is stopped (i.e., shut down) or terminated (i.e., deleted). Amazon <strong>Elastic Block Store (EBS)</strong> volumes provide persistent storage -- they're like the hard drive on a physical computer.</li>
</ul>
<p>Creating an instance, then, still entails several decisions, even before getting to the software installation stage.</p>
<p>Thankfully, Louis Aslett has simplified the process by creating <a href="https://www.louisaslett.com/RStudio_AMI/">RStudio Server AMIs</a>. We still have to choose an instance type, but the image features 20 GB default EBS and includes a ton of useful software.</p>
<h5>Bonus Failure Notes</h5>
<p>I initially tried configuring everything from scratch, following the Longer, Detailed Way steps in <a href="https://jagg19.github.io/2019/08/aws-r/">Jagger Villalobos's tutorial</a>. It's a great tutorial, but the long way turned into a time-consuming headache for me for two reasons. First, the tutorial assumes you're using a UNIX-like operating system to work with the EC2 instance. While the instance is a virtual computer, we still need to access it with an actual machine. Leaving access unregulated is a bad idea, which is where key pairs come in. The EC2 instance stores the public key, and the corresponding private key is needed to log in. Key management is different in Windows than in Linux and Mac OS. I eventually figured out <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/putty.html">how to connect with PuTTY</a>.</p>
<p>In retrospect, I should have sucked it up and updated my Windows Subsystem for Linux, but I still would have hit the next hurdle. I unwittingly chose the Amazon Linux AMI, which uses yum as its package manager. The commands to download R, RStudio, and other software are written for a machine running Ubuntu or Debian, which use apt-get instead of yum. The commands are different between the package managers. I'd like to be fluent in both, but today is not the day to accomplish that.</p>
<h4>2. Create an S3 bucket</h4>
<p>S3 stands for Simple Storage Service and is exactly what it says -- simple, web-based object storage. EC2 instances come with persistent storage in the form of EBS volumes. Why create an S3 bucket then? One, S3 storage is cheaper. Two, files in an S3 bucket can be accessed by multiple computers (even physical, non-AWS-hosted ones), whereas an EBS volume is mounted to one EC2 instance at a time. This means that it's possible for different people on different machines to work wiht the data. (<a href="https://dzone.com/articles/confused-by-aws-storage-options-s3-ebs-amp-efs-explained">See here</a> for a table comparing different AWS storage options and <a href="https://www.missioncloud.com/blog/resource-amazon-ebs-vs-efs-vs-s3-picking-the-best-aws-storage-option-for-your-business">here</a> for another comparison of use cases).</p>
<p>Creating the bucket itself was the most straightforward part of the process -- it's just a wizard. I chose to encrypt objects automatically with AES-256, and kept the default option to block all public access. One thing worth noting is that access requests should be logged to a different bucket.</p>
<h4>3. Set up an IAM policy</h4>
<p>Even though all the data I plan on hosting is publicly available, it's worth getting in the habit of securing S3 buckets. To do this, I set up an <a href="https://console.aws.amazon.com/iam/home">Identity and Access Management (IAM)</a> policy and role, then attached the role to my EC2 instance.</p>
<p>First, the policy. Amazon offers several policies out of the box, but I wanted one that restricted access to just the bucket where project data will be stored. The policy below isn't perfect, but it's a workable first iteration that does what I need it to do. It was modified from the policy <a href="https://aws.amazon.com/blogs/big-data/running-r-on-aws/">in this old AWS blog post</a>, which unfortunately got me an error when I tried to use it to access my S3 bucket from RStudio Server.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>    <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span><br>    <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>        <span class="token punctuation">{</span><br>            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span><br>            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"s3:GetBucketLocation"</span><span class="token punctuation">,</span><br>                <span class="token string">"s3:ListAllMyBuckets"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"arn:aws:s3:::*"</span><br>            <span class="token punctuation">]</span><br>        <span class="token punctuation">}</span><span class="token punctuation">,</span><br>        <span class="token punctuation">{</span><br>            <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span><br>            <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"s3:*"</span><br>            <span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span><br>                <span class="token string">"arn:aws:s3:::mybucket"</span><span class="token punctuation">,</span><br>                <span class="token string">"arn:aws:s3:::mybucket/*"</span><br>            <span class="token punctuation">]</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">]</span><br><span class="token punctuation">}</span></code></pre>
<p>Then, I created the role, which is a straightforward, wizard-driven process. Finally, I attached the role to the EC2 instance by right-clicking and assigning the role.</p>
<p><img src="img/ec2-iam-role.jpg" alt="Screenshot of the AWS EC2 Instances console, showing a right-click menu with 'Attach/Replace IAM Role' selected"></p>
<h5>Alt Route with Users and Groups</h5>
<p>An alternative to creating a role is to create a user with programmatic access. This generates an access key ID and secret access key that can be used with various AWS tools, including to access S3 via our scripts. Going this route enables S3 access from other machines besides our EC2 instance.</p>
<p><img src="img/iam-user-1.jpg" alt="Screenshot of step one in the AWS 'Add User' wizard"></p>
<p>The second screen lets us add the user to a group to which IAM policies are attached. While it's best practice to manage permissions on a group basis, it is possible to attach policies directly.</p>
<p><img src="img/iam-user-2.jpg" alt="Screenshot of step two in the AWS 'Add User' wizard"></p>
<p>The rest of the wizard can be stepped through. Access keys can be generated from the IAM console -- click on the user name, then the Security credentials tab.</p>
<p><img src="img/iam-user-3.jpg" alt="Screenshot of the AWS IAM console. The 'Create access key' button is highlighted."></p>
<h4>4. Configure RStudio Server</h4>
<p>After all this, it's still not quite done. The AMI comes loaded with RStudio and packages like the tidyverse, but a few more libraries are needed to be able to access the S3 bucket.</p>
<p><code>aws.s3</code> provides a way to access buckets and read and save objects to them.</p>
<p>The bucket isn't public, so I also need a way to pass credentials. There are a couple of ways to do this.</p>
<p>Since I set up an IAM role and attached it to the EC2 instance, the easiest way to ensure access to the S3 bucket is by installing the <code>aws.ec2metadata</code> package. There's no need to load the library once it's installed -- it just needs to be installed to work.</p>
<pre class="language-r"><code class="language-r">install.packages<span class="token punctuation">(</span><span class="token string">"aws.s3"</span><span class="token punctuation">,</span> <span class="token string">"aws.ec2metadata"</span><span class="token punctuation">)</span><br>library<span class="token punctuation">(</span>aws.s3<span class="token punctuation">)</span><br><br><span class="token comment"># confirm access</span><br>bucketlist<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>The policy I set up makes all S3 buckets visible, even if the EC2 instance doesn't have read/write access, so not every bucket name returned can actually be accessed.</p>
<h5>An alternative method</h5>
<p>Going the alt route and managing access with users, groups, and keys (instead of with roles), access details can be added to the <code>.Renviron</code> file. <code>usethis</code> provides a way to modify the <code>.Renviron</code>. <code>devtools</code> is a prerequisite for <code>usethis</code>.</p>
<pre class="language-r"><code class="language-r">install.packages<span class="token punctuation">(</span><span class="token string">"devtools"</span><span class="token punctuation">)</span><br>install.packages<span class="token punctuation">(</span><span class="token string">"usethis"</span><span class="token punctuation">)</span><br><br><span class="token comment"># edit the environment file</span><br>usethis<span class="token operator">::</span>edit_r_environ<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>Update <code>.Renviron</code> accordingly, save and restart the R session. For the East Coast, the default region is probably &quot;us-east-2&quot;.</p>
<pre class="language-r"><code class="language-r">AWS_ACCESS_KEY_ID <span class="token operator">=</span> <span class="token string">"your-key-here"</span><br>AWS_SECRET_ACCESS_KEY <span class="token operator">=</span> <span class="token string">"your-secret-here"</span><br>AWS_DEFAULT_REGION <span class="token operator">=</span> <span class="token string">"region-here"</span></code></pre>
<h4>5. Access the bucket from RStudio</h4>
<p>If all goes well, we should be able to see a list of accessible buckets with <code>aws.s3::bucketlist()</code>, and view the contents of a bucket with <code>aws.s3::get_bucket(&quot;bucket_name&quot;)</code></p>
<pre class="language-r"><code class="language-r">library<span class="token punctuation">(</span>aws.s3<span class="token punctuation">)</span><br><br><span class="token comment"># confirm access</span><br>bucketlist<span class="token punctuation">(</span><span class="token punctuation">)</span><br><br><span class="token comment"># check out bucket contents</span><br>get_bucket<span class="token punctuation">(</span><span class="token string">"mybucket"</span><span class="token punctuation">)</span><br><br><span class="token comment"># load a csv in the bucket to a data frame</span><br>counts <span class="token operator">&lt;-</span> s3read_using<span class="token punctuation">(</span>read.csv<span class="token punctuation">,</span> <br>                       object <span class="token operator">=</span> <span class="token string">"counts.csv"</span><span class="token punctuation">,</span> <br>                       bucket <span class="token operator">=</span> <span class="token string">"mybucket"</span><span class="token punctuation">)</span></code></pre>
<h4>n. Connect the GitHub Repo</h4>
<p>We still have to bring in the actual project code. This process is the same on the EC2 RStudio Server instance as it is on RStudio desktop, thankfully.</p>

        </article>
    
        </main>

        <footer>
            <!-- <span class="credit">amfz</span> -->
            <!-- <a href="#site">^top</a> -->
        </footer>
    </div>
</body>
</html>